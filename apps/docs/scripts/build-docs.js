#!/usr/bin/env node
/**
 * Build Docs Script
 * Finds all .docs.json files and renders them to HTML
 */

import { existsSync, mkdirSync, readFileSync, readdirSync, statSync, writeFileSync } from 'node:fs';
import { dirname, join, relative } from 'node:path';
import { fileURLToPath } from 'node:url';
import { renderDoc } from './render-section.js';

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = join(__dirname, '../../..');
const SRC_DIR = join(__dirname, '../src');
const OUTPUT_DIR = join(SRC_DIR, 'generated');

/**
 * Recursively find all .docs.json files
 */
function findDocsFiles(dir, files = []) {
  const entries = readdirSync(dir);

  for (const entry of entries) {
    const fullPath = join(dir, entry);
    const stat = statSync(fullPath);

    if (
      stat.isDirectory() &&
      !entry.startsWith('.') &&
      entry !== 'node_modules' &&
      entry !== 'dist'
    ) {
      findDocsFiles(fullPath, files);
    } else if (entry.endsWith('.docs.json')) {
      files.push(fullPath);
    }
  }

  return files;
}

/**
 * Capitalize first letter
 */
function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

/**
 * Resolve doc by merging with API if present
 */
function resolveDoc(doc, docsFilePath) {
  // If no api field, doc must have all required fields
  if (!doc.api) {
    return {
      id: doc.id,
      type: doc.type,
      title: doc.title,
      description: doc.description,
      sections: doc.sections,
      vars: null,
      componentName: null,
    };
  }

  // Load API file
  const apiPath = join(dirname(docsFilePath), doc.api);
  let api;
  try {
    api = JSON.parse(readFileSync(apiPath, 'utf-8'));
  } catch (err) {
    throw new Error(`Cannot read API file ${doc.api}: ${err.message}`);
  }

  // Merge: doc fields override api fields
  return {
    id: doc.id || api.name,
    type: doc.type || 'component',
    title: doc.title || capitalize(api.name),
    description: doc.description || api.description,
    sections: doc.sections,
    vars: api.vars || null,
    componentName: api.name,
  };
}

/**
 * Main build function
 */
function build() {
  console.log('Building docs from JSON files...\n');

  // Find all .docs.json files in packages/
  const packagesDir = join(ROOT, 'packages');
  const docsFiles = findDocsFiles(packagesDir);

  if (docsFiles.length === 0) {
    console.log('No .docs.json files found.');
    return;
  }

  console.log(`Found ${docsFiles.length} docs files:\n`);

  const renderedDocs = [];

  for (const file of docsFiles) {
    const relativePath = relative(ROOT, file);
    console.log(`  - ${relativePath}`);

    try {
      const content = readFileSync(file, 'utf-8');
      const doc = JSON.parse(content);
      const resolved = resolveDoc(doc, file);
      const html = renderDoc(resolved);
      renderedDocs.push({
        id: resolved.id,
        type: resolved.type,
        title: resolved.title,
        html,
      });
    } catch (err) {
      console.error(`    Error: ${err.message}`);
    }
  }

  // Ensure output directory exists
  if (!existsSync(OUTPUT_DIR)) {
    mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  // Group by type for organized output
  const byType = {
    token: [],
    primitive: [],
    component: [],
    utility: [],
  };

  for (const doc of renderedDocs) {
    if (byType[doc.type]) {
      byType[doc.type].push(doc);
    }
  }

  // Build docs content HTML
  const docsContent = [
    '<!-- Tokens -->',
    ...byType.token.map((d) => d.html),
    '',
    '<!-- Primitives -->',
    ...byType.primitive.map((d) => d.html),
    '',
    '<!-- Components -->',
    ...byType.component.map((d) => d.html),
    '',
    '<!-- Utilities -->',
    ...byType.utility.map((d) => d.html),
  ].join('\n');

  // Build navigation HTML
  const navGroups = [
    { label: 'Tokens', items: byType.token },
    { label: 'Primitives', items: byType.primitive },
    { label: 'Components', items: byType.component },
    { label: 'Utilities', items: byType.utility },
  ];

  const navHtml = navGroups
    .filter((group) => group.items.length > 0)
    .map((group, idx) => {
      const heading = `<h2 class="ui-text-xs ui-font-bold ui-uppercase ui-text-muted${idx > 0 ? ' ui-mt-4' : ''}">${group.label}</h2>`;
      const links = group.items
        .sort((a, b) => a.title.localeCompare(b.title))
        .map((doc) => `      <a class="ui-nav-link" href="#${doc.id}">${doc.title}</a>`)
        .join('\n');
      return `${idx > 0 ? '\n      ' : ''}${heading}\n${links}`;
    })
    .join('\n');

  // Write standalone docs-content.html (for reference)
  const contentFile = join(OUTPUT_DIR, 'docs-content.html');
  writeFileSync(contentFile, `<!-- Generated by build-docs.js - DO NOT EDIT -->\n\n${docsContent}`);
  console.log(`\nGenerated: ${relative(ROOT, contentFile)}`);

  // Read template and inject content
  const templateFile = join(SRC_DIR, 'index.template.html');
  const template = readFileSync(templateFile, 'utf-8');
  const indexHtml = template
    .replace('<!-- DOCS_NAV -->', navHtml)
    .replace('<!-- DOCS_CONTENT -->', docsContent);

  // Write index.html
  const indexFile = join(SRC_DIR, 'index.html');
  writeFileSync(indexFile, indexHtml);
  console.log(`Generated: ${relative(ROOT, indexFile)}`);

  console.log('Done!');
}

build();
